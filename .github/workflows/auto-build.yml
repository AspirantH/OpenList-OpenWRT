name: Auto Build Packages

on:
  # 每日UTC时间0点触发（北京时间+8小时，即上午8点）
  schedule:
    - cron: '0 0 * * *'
  # 保留仓库事件调度触发（可选，用于手动触发）
  repository_dispatch:
    types: [release-build]

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      tag_name: ${{ steps.set_tag.outputs.tag_name }}  # 明确输出Tag名称，避免依赖步骤间隐式传递
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0  # 拉取所有历史，确保Tag能被识别

      - name: Set Tag and Release Info
        id: set_tag
        run: |
          # 区分触发方式，设置标签和发布名称
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            TAG_NAME="${{ github.event.client_payload.release_tag }}"
            RELEASE_NAME="${{ github.event.client_payload.release_name }}"
          else
            # 定时触发：使用"nightly-日期-随机串"避免Tag重复（如nightly-20251104-abc123）
            TAG_NAME="nightly-$(date +%Y%m%d)-$(git rev-parse --short HEAD)"
            RELEASE_NAME="Nightly Build $(date +%Y-%m-%d) (${{ github.sha }})"
          fi
          
          # 输出变量供后续步骤使用
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "TAG_NAME: $TAG_NAME"
          echo "RELEASE_NAME: $RELEASE_NAME"

      - name: Create Tag (本地+远程)
        run: |
          TAG_NAME="${{ steps.set_tag.outputs.tag_name }}"
          # 配置Git用户信息（用于创建Tag）
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 删除已存在的本地/远程Tag（避免重复推送失败）
          if git tag | grep -q "^$TAG_NAME$"; then
            git tag -d $TAG_NAME
          fi
          if git ls-remote --tags origin | grep -q "^.*refs/tags/$TAG_NAME$"; then
            git push origin :refs/tags/$TAG_NAME
          fi
          
          # 重新创建并推送Tag（--force确保推送成功）
          git tag -a $TAG_NAME -m "Nightly Build Tag: $TAG_NAME"
          git push origin $TAG_NAME --force
          
          # 等待3秒，给GitHub Tag同步留时间（关键：解决时序竞争）
          sleep 3

      - name: Create/Update GitHub Release
        id: create_release
        uses: ncipollo/release-action@v1
        with:
          name: ${{ steps.set_tag.outputs.release_name }}
          tag: ${{ steps.set_tag.outputs.tag_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          prerelease: true
          body: |
            ## ${{ steps.set_tag.outputs.tag_name }}
            
            This is an automated nightly build of OpenWrt packages.
            
            **Build Date:** $(date +%Y-%m-%d)
            **Source Commit:** ${{ github.sha }}
            **Source Repository:** ${{ github.repositoryUrl }}
          allowUpdates: true  # 允许更新已存在的Release（避免重复创建失败）
          replacesArtifacts: false  # 不替换已上传的 artifacts

  build:
    name: Build ${{ matrix.arch }}-${{ matrix.sdk }}
    runs-on: ubuntu-latest
    needs: create-release  # 依赖create-release完成，确保Tag已同步
    strategy:
      fail-fast: false
      matrix:
        arch:
          - x86_64
        sdk:
          - openwrt-24.10

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-release.outputs.tag_name }}  # 直接checkout到创建的Tag，确保Tag存在
          fetch-depth: 0

      - name: Build with Static Linking
        run: |
          # 安全修改Makefile：先判断行是否存在，避免重复添加
          if ! grep -q "GO_PKG_DEFAULT_LDFLAGS:=-w -s -extldflags \"-static\"" openlist/Makefile; then
            sed -i '/golang-package/a \\tGO_PKG_DEFAULT_LDFLAGS:=-w -s -extldflags "-static"' openlist/Makefile
          fi

      - name: UPX Compress (Skip Unsupported Archs)
        run: |
          # 简化条件判断，避免冗余
          UNSUPPORTED_ARCHS=("loongarch64_generic" "mips64_mips64r2" "mips64_octeonplus" "mips64el_mips64r2" "riscv64_riscv64")
          if [[ ! " ${UNSUPPORTED_ARCHS[@]} " =~ " ${matrix.arch} " ]]; then
            # 避免重复添加UPX命令
            if ! grep -q "/usr/bin/upx --lzma --best" openlist/Makefile; then
              sed -i '/openlist.init/a \\t/usr/bin/upx --lzma --best $(1)\/usr\/bin\/openlist' openlist/Makefile
            fi
          fi

      - name: Build Packages
        uses: OpenListTeam/openwrt-gh-action-sdk@go1.25
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.sdk }}
          FEEDNAME: packages_ci
          PACKAGES: luci-app-openlist
          NO_REFRESH_CHECK: true

      - name: Upload artifacts (Build Output)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.arch }}-${{ matrix.sdk }}
          path: |
            bin/packages/${{ matrix.arch }}/packages_ci/*.apk
            bin/packages/${{ matrix.arch }}/packages_ci/*.ipk
          retention-days: 7  #  artifacts保留7天，节省存储空间

      - name: Create Compressed Package Archive
        continue-on-error: true
        run: |
          # 确保输出目录存在
          mkdir -p build-output
          tar -zcvf build-output/${{ matrix.sdk }}-${{ matrix.arch }}.tar.gz -C bin/packages/${{ matrix.arch }}/ packages_ci

      - name: Upload to GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.create-release.outputs.tag_name }}  # 明确使用创建的Tag
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          replacesArtifacts: false
          omitBody: true
          omitName: true
          artifacts: "build-output/${{ matrix.sdk }}-${{ matrix.arch }}.tar.gz"
