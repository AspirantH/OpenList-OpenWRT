name: Auto Build Packages

on:
  schedule:
    - cron: '0 0 * * *'  # 每日UTC 0点（北京时间8点）触发
  repository_dispatch:
    types: [release-build]

permissions:
  contents: write
  packages: read  # 新增：允许读取GitHub Packages（可能影响SDK拉取）

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      tag_name: ${{ steps.set_tag.outputs.tag_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Set Tag and Release Info
        id: set_tag
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            TAG_NAME="${{ github.event.client_payload.release_tag }}"
            RELEASE_NAME="${{ github.event.client_payload.release_name }}"
          else
            TAG_NAME="nightly-$(date +%Y%m%d)-$(git rev-parse --short HEAD)"
            RELEASE_NAME="Nightly Build $(date +%Y-%m-%d) (${{ github.sha }})"
          fi
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "TAG_NAME: $TAG_NAME"
          echo "RELEASE_NAME: $RELEASE_NAME"

      - name: Create Tag (本地+远程)
        run: |
          TAG_NAME="${{ steps.set_tag.outputs.tag_name }}"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 优化Tag删除逻辑，避免 grep 匹配异常
          if git rev-parse --verify --quiet "$TAG_NAME" >/dev/null; then
            git tag -d "$TAG_NAME"
          fi
          if git ls-remote --tags origin "refs/tags/$TAG_NAME" >/dev/null 2>&1; then
            git push origin ":refs/tags/$TAG_NAME"
          fi
          
          git tag -a "$TAG_NAME" -m "Nightly Build Tag: $TAG_NAME"
          git push origin "$TAG_NAME" --force
          sleep 5  # 延长等待时间，确保GitHub完全同步Tag

      - name: Create/Update GitHub Release
        id: create_release
        uses: ncipollo/release-action@v1
        with:
          name: ${{ steps.set_tag.outputs.release_name }}
          tag: ${{ steps.set_tag.outputs.tag_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          prerelease: true
          # 修复date命令不执行的问题：使用env传递日期
          body: |
            ## ${{ steps.set_tag.outputs.tag_name }}
            
            This is an automated nightly build of OpenWrt packages.
            
            **Build Date:** ${{ env.BUILD_DATE }}
            **Source Commit:** ${{ github.sha }}
            **Source Repository:** ${{ github.repositoryUrl }}
          env:
            BUILD_DATE: ${{ steps.set_tag.outputs.release_name =~ /\(([0-9]{4}-[0-9]{2}-[0-9]{2})\)/ && regexReplaceAll('\D', '$1', '') || formatDate(utcNow(), 'yyyy-MM-dd') }}
          allowUpdates: true
          replacesArtifacts: false

  build:
    name: Build ${{ matrix.arch }}-${{ matrix.sdk }}
    runs-on: ubuntu-latest
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64]
        sdk: [openwrt-24.10]

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main  # 关键修复：构建应基于main分支源码，而非Tag（Tag仅用于标记版本）
          fetch-depth: 0

      - name: 安装依赖工具
        run: |
          # 确保UPX和必要工具安装（避免编译时找不到命令）
          sudo apt-get update && sudo apt-get install -y upx-ucl
          # 验证工具安装
          upx --version || echo "UPX安装失败"

      - name: 修复Makefile静态编译配置
        run: |
          # 更可靠的Makefile修改方式：定位正确的位置（golang-package目标）
          MAKEFILE="openlist/Makefile"
          if [ ! -f "$MAKEFILE" ]; then
            echo "错误：找不到Makefile文件 $MAKEFILE"
            exit 1
          fi
          
          # 确保GO_PKG_DEFAULT_LDFLAGS配置正确（静态编译关键）
          if ! grep -q "GO_PKG_DEFAULT_LDFLAGS" "$MAKEFILE"; then
            # 如果没有该配置，添加到golang-package目标下
            sed -i '/define Build\/golang-package/i \\tGO_PKG_DEFAULT_LDFLAGS:=-w -s -extldflags "-static"' "$MAKEFILE"
          else
            # 如果已有配置，替换为静态编译参数
            sed -i 's/GO_PKG_DEFAULT_LDFLAGS:=.*/GO_PKG_DEFAULT_LDFLAGS:=-w -s -extldflags "-static"/' "$MAKEFILE"
          fi
          
          # 显示修改后的Makefile关键部分（用于调试）
          grep -A 5 -B 5 "GO_PKG_DEFAULT_LDFLAGS" "$MAKEFILE"

      - name: 配置UPX压缩（仅支持架构）
        run: |
          MAKEFILE="openlist/Makefile"
          UNSUPPORTED_ARCHS=("loongarch64_generic" "mips64_mips64r2" "mips64_octeonplus" "mips64el_mips64r2" "riscv64_riscv64")
          
          if [[ ! " ${UNSUPPORTED_ARCHS[@]} " =~ " ${matrix.arch} " ]]; then
            # 确保UPX命令添加到正确位置（安装后压缩）
            if ! grep -q "/usr/bin/upx" "$MAKEFILE"; then
              sed -i '/define Package\/openlist\/install/a \\t/usr/bin/upx --lzma --best $(1)/usr/bin/openlist || true' "$MAKEFILE"
            fi
          else
            echo "当前架构 ${matrix.arch} 不支持UPX，跳过压缩"
          fi

      - name: 构建OpenWrt包（带详细日志）
        uses: OpenListTeam/openwrt-gh-action-sdk@go1.25
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.sdk }}
          FEEDNAME: packages_ci
          PACKAGES: luci-app-openlist openlist  # 关键修复：同时构建依赖包openlist
          NO_REFRESH_CHECK: true
          VERBOSE: 1  # 开启详细日志，便于调试

      - name: 显示构建输出目录结构（关键调试步骤）
        run: |
          echo "=== 构建输出目录结构 ==="
          find bin/ -type f -name "*.ipk" -o -name "*.apk" || echo "未找到任何ipk/apk文件"
          echo "=== bin/packages 目录详情 ==="
          ls -laR bin/packages/ || echo "bin/packages目录不存在"

      - name: 上传构建产物到Artifacts（用于调试）
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.arch }}-${{ matrix.sdk }}-build-output
          path: |
            bin/packages/**/*.ipk
            bin/packages/**/*.apk
            bin/packages/**/*.tar.gz
          retention-days: 7

      - name: 打包构建产物
        run: |
          # 确保构建产物存在
          BUILD_DIR="bin/packages/${{ matrix.arch }}/packages_ci"
          if [ ! -d "$BUILD_DIR" ]; then
            echo "错误：构建目录 $BUILD_DIR 不存在"
            exit 1
          fi
          
          # 检查是否有产物文件
          if [ $(find "$BUILD_DIR" -name "*.ipk" -o -name "*.apk" | wc -l) -eq 0 ]; then
            echo "错误：构建目录中没有找到ipk/apk文件"
            exit 1
          fi
          
          # 创建压缩包（包含所有产物）
          mkdir -p build-output
          tar -zcvf build-output/${{ matrix.sdk }}-${{ matrix.arch }}-packages.tar.gz -C "$BUILD_DIR" .
          echo "压缩包创建成功："
          ls -la build-output/

      - name: 上传压缩包到GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.create-release.outputs.tag_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          replacesArtifacts: false
          omitBody: true
          omitName: true
          artifacts: "build-output/${{ matrix.sdk }}-${{ matrix.arch }}-packages.tar.gz"
          artifactContentType: "application/gzip"
